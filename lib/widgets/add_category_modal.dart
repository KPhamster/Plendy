import 'package:flutter/material.dart';
import 'package:plendy/models/user_category.dart';
import 'package:plendy/services/experience_service.dart';

class AddCategoryModal extends StatefulWidget {
  final UserCategory? categoryToEdit;

  const AddCategoryModal({super.key, this.categoryToEdit});

  @override
  State<AddCategoryModal> createState() => _AddCategoryModalState();
}

class _AddCategoryModalState extends State<AddCategoryModal> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  final ExperienceService _experienceService = ExperienceService();
  String _selectedIcon = '';
  bool _isLoading = false;

  bool get _isEditing => widget.categoryToEdit != null;

  // Expanded list of emojis for selection
  final List<String> _emojiOptions = [
    // Food & Drink
    'ğŸ', 'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­',
    'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ«›', 'ğŸ¥’', 'ğŸŒ¶ï¸', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ«‘', 'ğŸ¥”', 'ğŸ§…', 'ğŸ§„', 'ğŸ„', 'ğŸ¥œ',
    'ğŸŒ°', 'ğŸ', 'ğŸ¥', 'ğŸ¥¯', 'ğŸ¥', 'ğŸ³', 'ğŸ§‡', 'ğŸ¥“', 'ğŸ¥©', 'ğŸ—', 'ğŸ–', 'ğŸ¤', 'ğŸ£', 'ğŸ±', 'ğŸš', 'ğŸ›', 'ğŸœ',
    'ğŸ²', 'ğŸ¥£', 'ğŸ¥—', 'ğŸ', 'ğŸ ', 'ğŸ¥¡', 'ğŸ¥ª', 'ğŸŒ­', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸ¥«', 'ğŸ¥™', 'ğŸ¥˜', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ¥¨', 'ğŸ¥Ÿ',
    'ğŸ¦ª', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¢', 'ğŸ¡', 'ğŸ§', 'ğŸ¨', 'ğŸ¦', 'ğŸ¥§', 'ğŸ°', 'ğŸ‚', 'ğŸ§', 'ğŸ®', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ¿', 'ğŸ©', 'ğŸª',
    'ğŸ¯', 'ğŸ¥¤', 'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š', 'ğŸ¥›', 'â˜•', 'ğŸ«–', 'ğŸ§‹', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ',
    
    // Utensils & Tableware
    'ğŸ½ï¸', 'ğŸ¥¢', 'ğŸ´', 'ğŸ¥„', 'ğŸ§‚',

    // Places & Buildings
    'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ¯', 'ğŸ°', 'ğŸ›ï¸', 'â›ª', 'ğŸ•Œ', 'ğŸ•',
    'â›©ï¸', 'ğŸ•‹', 'â›²', 'ğŸ—½', 'ğŸ—¼', 'ğŸŸï¸', 'ğŸ¡', 'ğŸ¢', 'ğŸ ', 'â›º', 'ğŸ•ï¸', 'ğŸ–ï¸', 'ğŸœï¸', 'ğŸï¸', 'ğŸï¸', 'â›°ï¸', 'ğŸ”ï¸', 'ğŸ—»', 'ğŸŒ‹', 'ğŸ—ï¸', 'ğŸ›–',
    'ğŸ›£ï¸', 'ğŸ›¤ï¸', 'ğŸ—ºï¸', 'ğŸ§­', 'ğŸ“', 'ğŸ˜ï¸', 'ğŸŒ³', 'ğŸŒ†', 'ğŸŒ‡', 'ğŸŒ…', 'ğŸŒ„', 'â›±ï¸', 'ğŸ›ï¸', 'ğŸ›’', 'ğŸ’ˆ', 'â™¨ï¸', 'â­', 'ğŸŒ ', 'ğŸŒŒ', 'ğŸª', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸª¨', 'ğŸªµ',
    'â„ï¸', 'â˜ƒï¸',

    // Nature & Plants
    'ğŸŒµ', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒ±', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‹', 'ğŸ‚', 'ğŸ', 'ğŸƒ', 'ğŸª´', 'ğŸµï¸', 'ğŸŒ¸', 'ğŸŒ¹', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸ’', 'ğŸ¥€',

    // Animals
    'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’',
    'ğŸ¦', 'ğŸ¦§', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ', 'ğŸª²', 'ğŸ›', 'ğŸ', 'ğŸ¦‹', 'ğŸŒ', 'ğŸœ', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ¦‚', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦Ÿ', 'ğŸ ', 'ğŸŸ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦­', 'ğŸ¦¦', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸª¼', 'ğŸ™', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦’', 'ğŸ˜', 'ğŸ¦', 'ğŸ¦›', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦˜', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ¦¢', 'ğŸ¦©', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¦ƒ', 'ğŸ“', 'ğŸ¦¤', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦§', 'ğŸ¦£', 'ğŸ¦«', 'ğŸ‡', 'ğŸ¦', 'ğŸ¦¡', 'ğŸ¦¥', 'ğŸ¦¬', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦©', 'ğŸ‰', 'ğŸ²', 'ğŸª½', 'ğŸ•Šï¸', 'ğŸ¦â€â¬›', 'ğŸ¤', 'ğŸ¦¢',

    // Faces & People
    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ¥²', 'ğŸ¥¹', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ«¢', 'ğŸ«£', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ« ', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜¶â€ğŸŒ«ï¸', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ˜µâ€ğŸ’«', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ«¤', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ‘¶', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§‘', 'ğŸ‘±', 'ğŸ‘¨', 'ğŸ§”', 'ğŸ‘¨â€ğŸ¦°', 'ğŸ‘¨â€ğŸ¦±', 'ğŸ‘¨â€ğŸ¦³', 'ğŸ‘¨â€ğŸ¦²', 'ğŸ‘©', 'ğŸ‘©â€ğŸ¦°', 'ğŸ‘©â€ğŸ¦±', 'ğŸ‘©â€ğŸ¦³', 'ğŸ‘©â€ğŸ¦²', 'ğŸ‘±â€â™€ï¸', 'ğŸ‘±â€â™‚ï¸', 'ğŸ§“', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ™â€â™‚ï¸', 'ğŸ™â€â™€ï¸', 'ğŸ™â€â™‚ï¸', 'ğŸ™â€â™€ï¸', 'ğŸ™…â€â™‚ï¸', 'ğŸ™…â€â™€ï¸', 'ğŸ™†â€â™‚ï¸', 'ğŸ™†â€â™€ï¸', 'ğŸ’â€â™€ï¸', 'ğŸ’â€â™‚ï¸', 'ğŸ™‹â€â™€ï¸', 'ğŸ™‹â€â™‚ï¸', 'ğŸ§â€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ™‡â€â™‚ï¸', 'ğŸ™‡â€â™€ï¸', 'ğŸ¤¦â€â™‚ï¸', 'ğŸ¤¦â€â™€ï¸', 'ğŸ¤·â€â™‚ï¸', 'ğŸ¤·â€â™€ï¸', 'ğŸ§‘â€âš•ï¸', 'ğŸ§‘â€ğŸ“', 'ğŸ§‘â€ğŸ«', 'ğŸ§‘â€âš–ï¸', 'ğŸ§‘â€ğŸŒ¾', 'ğŸ§‘â€ğŸ³', 'ğŸ§‘â€ğŸ”§', 'ğŸ§‘â€ğŸ­', 'ğŸ§‘â€ğŸ’¼', 'ğŸ§‘â€ğŸ”¬', 'ğŸ§‘â€ğŸ’»', 'ğŸ§‘â€ğŸ¤', 'ğŸ§‘â€ğŸ¨', 'ğŸ§‘â€âœˆï¸', 'ğŸ§‘â€ğŸš€', 'ğŸ§‘â€ğŸš’', 'ğŸ‘®â€â™€ï¸', 'ğŸ‘®â€â™‚ï¸', 'ğŸ•µï¸â€â™€ï¸', 'ğŸ•µï¸â€â™‚ï¸', 'ğŸ’‚â€â™€ï¸', 'ğŸ’‚â€â™‚ï¸', 'ğŸ¥·', 'ğŸ‘·â€â™€ï¸', 'ğŸ‘·â€â™‚ï¸', 'ğŸ¤´', 'ğŸ‘¸', 'ğŸ‘³â€â™‚ï¸', 'ğŸ‘³â€â™€ï¸', 'ğŸ‘²', 'ğŸ§•', 'ğŸ¤µ', 'ğŸ‘°', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ«„', 'ğŸ«ƒ', 'ğŸ§‘â€ğŸ¼', 'ğŸ‘¼', 'ğŸ…', 'ğŸ¤¶', 'ğŸ§‘â€ğŸ„', 'ğŸ¦¸â€â™‚ï¸', 'ğŸ¦¸â€â™€ï¸', 'ğŸ¦¹â€â™‚ï¸', 'ğŸ¦¹â€â™€ï¸', 'ğŸ§™â€â™‚ï¸', 'ğŸ§™â€â™€ï¸', 'ğŸ§šâ€â™‚ï¸', 'ğŸ§šâ€â™€ï¸', 'ğŸ§›â€â™‚ï¸', 'ğŸ§›â€â™€ï¸', 'ğŸ§œâ€â™‚ï¸', 'ğŸ§œâ€â™€ï¸', 'ğŸ§â€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§â€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§Ÿâ€â™‚ï¸', 'ğŸ§Ÿâ€â™€ï¸', 'ğŸ§Œ', 'ğŸš¶â€â™‚ï¸', 'ğŸš¶â€â™€ï¸', 'ğŸ§â€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§â€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§‘â€ğŸ¦¯', 'ğŸ§‘â€ğŸ¦¼', 'ğŸ§‘â€ğŸ¦½', 'ğŸƒâ€â™‚ï¸', 'ğŸƒâ€â™€ï¸', 'ğŸ’ƒ', 'ğŸ•º', 'ğŸ§—', 'ğŸ§—â€â™‚ï¸', 'ğŸ§—â€â™€ï¸', 'ğŸ‡', 'ğŸ‚', 'ğŸŒï¸â€â™€ï¸', 'ğŸŒï¸â€â™‚ï¸', 'ğŸ„â€â™‚ï¸', 'ğŸ„â€â™€ï¸', 'ğŸŠâ€â™‚ï¸', 'ğŸŠâ€â™€ï¸', 'ğŸš£â€â™‚ï¸', 'ğŸš£â€â™€ï¸',

    // Hand Gestures
    'â˜ï¸', 'ğŸ‘†', 'ğŸ‘‡', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ––', 'âœ‹', 'ğŸ¤š', 'ğŸ–ï¸', 'ğŸ–‘', 'ğŸ¤™', 'ğŸ«±', 'ğŸ«²', 'ğŸ«³', 'ğŸ«´', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ«°', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ«¶', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ™', 'ğŸ«‚', 'âœï¸',
    
    // Objects & Everyday Items
    'ğŸ’„', 'ğŸ’‹', 'ğŸ’', 'ğŸ’', 'âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ§®', 'ğŸ¥', 'ğŸ“·', 'ğŸ“¹', 'ğŸ“¼',
    'â˜ï¸', 'ğŸ“', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'â°', 'â±ï¸', 'â²ï¸', 'ğŸ•°ï¸', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸ§¯', 'ğŸ›¢ï¸', 'ğŸ›’', 'ğŸ’³', 'ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ§¾', 'ğŸ’¼', 'ğŸ“', 'ğŸ“‚', 'ğŸ—‚ï¸', 'ğŸ“…', 'ğŸ“†', 'ğŸ—’ï¸', 'ğŸ—“ï¸', 'ğŸ“‡', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“Š', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ—‘ï¸', 'ğŸ”’', 'ğŸ”“', 'ğŸ”', 'ğŸ”', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸ”¨', 'ğŸª“', 'â›ï¸', 'âš’ï¸', 'ğŸ› ï¸', 'ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ”«', 'ğŸªƒ', 'ğŸ¹', 'ğŸ›¡ï¸', 'ğŸ”§', 'ğŸª›', 'ğŸ”©', 'âš™ï¸', 'ğŸ›', 'ğŸ§±', 'â›“ï¸', 'ğŸ§²', 'ğŸªœ', 'âš—ï¸', 'ğŸ§ª', 'ğŸ§«', 'ğŸ§¬', 'ğŸ”¬', 'ğŸ”­', 'ğŸ“¡', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ’Š', 'ğŸ©¹', 'ğŸ©º',

    // Clothing & Accessories
    'ğŸ‘“', 'ğŸ•¶ï¸', 'ğŸ¥½', 'ğŸ¥¼', 'ğŸ¦º', 'ğŸ‘”', 'ğŸ‘•', 'ğŸ‘–', 'ğŸ§£', 'ğŸ§¤', 'ğŸ§¥', 'ğŸ§¦', 'ğŸ‘—', 'ğŸ‘˜', 'ğŸ¥»', 'ğŸ©±', 'ğŸ©²', 'ğŸ©³', 'ğŸ‘™', 'ğŸ‘š', 'ğŸ‘›', 'ğŸ‘œ', 'ğŸ‘', 'ğŸ›ï¸', 'ğŸ’', 'ğŸ©´', 'ğŸ‘', 'ğŸ‘Ÿ', 'ğŸ¥¾', 'ğŸ¥¿', 'ğŸ‘ ', 'ğŸ‘¡', 'ğŸ©°', 'ğŸ‘¢', 'ğŸ‘‘', 'ğŸ‘’', 'ğŸ©', 'ğŸ“', 'ğŸ§¢', 'ğŸª–', 'â›‘ï¸', 'ğŸ’„', 'ğŸ’', 'ğŸ’¼', 

    // Music & Arts
    'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸµ', 'ğŸ¶', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸ¥', 'ğŸº', 'ğŸ»', 'ğŸ¬', 'ğŸ¨', 'ğŸ­',

    // Celebration & Party
    'ğŸ‚', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ‡', 'ğŸ†', 'âœ¨', 'ğŸª„', 'ğŸ', 'ğŸ', 'ğŸª…', 'ğŸª©', 'ğŸ€', 'ğŸ', 'ğŸª§', 'ğŸ§§', 'ğŸ', 

    // Sports & Activities
    'âš½', 'âš¾', 'ğŸ€', 'ğŸ', 'ğŸˆ', 'ğŸ‰', 'ğŸ±', 'ğŸ³', 'ğŸ¥', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ', 'ğŸ¥…', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ¥Œ', 'â›³', 'â›¸ï¸', 'ğŸ£', 'ğŸ½', 'ğŸ¿', 'ğŸ›·', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ¹', 'ğŸ§—', 'ğŸ§—â€â™‚ï¸', 'ğŸ§—â€â™€ï¸', 'ğŸšµ', 'ğŸšµâ€â™‚ï¸', 'ğŸšµâ€â™€ï¸', 'ğŸš´', 'ğŸš´â€â™‚ï¸', 'ğŸš´â€â™€ï¸', 'ğŸŠ', 'ğŸŠâ€â™‚ï¸', 'ğŸŠâ€â™€ï¸', 'ğŸ¤½', 'ğŸ¤½â€â™‚ï¸', 'ğŸ¤½â€â™€ï¸', 'ğŸ„', 'ğŸ„â€â™‚ï¸', 'ğŸ„â€â™€ï¸', 'ğŸ§˜', 'ğŸ‹ï¸', 'ğŸ‹ï¸â€â™‚ï¸', 'ğŸ‹ï¸â€â™€ï¸', 'ğŸ¤¸', 'ğŸ¤¸â€â™‚ï¸', 'ğŸ¤¸â€â™€ï¸', 'â›¹ï¸', 'â›¹ï¸â€â™‚ï¸', 'â›¹ï¸â€â™€ï¸', 'ğŸ¤¼', 'ğŸ¤¼â€â™‚ï¸', 'ğŸ¤¼â€â™€ï¸', 'ğŸ¤¾', 'ğŸ¤¾â€â™‚ï¸', 'ğŸ¤¾â€â™€ï¸', 'ğŸ§™â€â™‚ï¸', 'ğŸ§™â€â™€ï¸', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ²', 'ğŸ§©', 'ğŸ§¸', 'ğŸª', 'ğŸª€', 'ğŸ°', 'ğŸ¯', 'ğŸªƒ', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ¥', 'ğŸªƒ', 'ğŸ ', 'ğŸ¡', 'ğŸ¥', 

    // Awards & Achievement
    'ğŸ†', 'ğŸ…', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ«', 'ğŸŸï¸',

    // Science, Education & Office
    'ğŸ“–', 'ğŸ“š', 'ğŸ““', 'ğŸ“’', 'ğŸ“”', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ§®', 'ğŸ”¬', 'ğŸ”­', 'ğŸ›°ï¸', 'ğŸ”¬', 'ğŸ“¡', 'ğŸ§ª', 'ğŸ§«', 'ğŸ§¬', 'ğŸ“', 'âœï¸', 'âœ’ï¸', 'ğŸ–‹ï¸', 'ğŸ–Šï¸', 'ğŸ–Œï¸', 'ğŸ–ï¸', 'ğŸ“…', 'ğŸ“†', 'ğŸ—“ï¸', 'ğŸ“‡', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“Š', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ–‡ï¸', 

    // Transportation & Travel
    'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸ›»', 'ğŸš', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ¦½', 'ğŸ¦¼', 'ğŸ›´', 'ğŸš²', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš”', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸšš', 'ğŸš›', 'ğŸ›»', 'ğŸšœ', 'ğŸ›´', 'ğŸ›¹', 'ğŸ›¼', 'ğŸš‚', 'ğŸšƒ', 'ğŸš„', 'ğŸš…', 'ğŸš†', 'ğŸš‡', 'ğŸšˆ', 'ğŸš‰', 'ğŸšŠ', 'ğŸš', 'ğŸš', 'ğŸš‹', 'ğŸšŒ', 'ğŸš', 'ğŸš', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'â›µ', 'ğŸ›¥ï¸', 'ğŸš¤', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢', 'âœˆï¸', 'ğŸ›©ï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸª‚', 'ğŸ’º', 'ğŸš', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸª',

    // Shapes, Symbols, & Miscellaneous
    'â¤ï¸', 'ğŸ©·', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ©µ', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤', 'ğŸ©¶', 'ğŸ’”', 'â¤ï¸â€ğŸ”¥', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ”˜', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'ğŸŸ¤', 'âš«', 'âšª', 'ğŸŸ¥', 'ğŸŸ§', 'ğŸŸ¨', 'ğŸŸ©', 'ğŸŸ¦', 'ğŸŸª', 'ğŸŸ«', 'â¬›', 'â¬œ', 'â—¼ï¸', 'â—»ï¸', 'â—¾', 'â—½', 'â–ªï¸', 'â–«ï¸', 'â—¯', 'â“', 'â”', 'â—', 'â€¼ï¸', 'â‰ï¸', 'âœ”ï¸', 'â˜‘ï¸', 'âœ…', 'âŒ', 'âœ–ï¸', 'â•', 'â–', 'â—', 'âœ³ï¸', 'âœ´ï¸', 'â°', 'â¿', 'ã€½ï¸', 'ğŸ’²', 'ğŸ’¯', 'â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸', 'ğŸƒ', 'ğŸ€„', 'ğŸ´', 'ğŸ””', 'ğŸ”•', 'ğŸ”’', 'ğŸ”“', 'ğŸ”', 'ğŸ”', 'ğŸ”‘', 'ğŸ—ï¸', 'âš“', 'ğŸš¬', 'ğŸª¦', 'âš–ï¸', 'â™€ï¸', 'â™‚ï¸', 'âš§ï¸',

    // Weather
    'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ§ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒªï¸', 'ğŸŒ«ï¸', 'ğŸŒ¬ï¸', 'ğŸŒˆ', 'â˜ƒï¸', 'ğŸŒ‚', 'â˜”', 'ğŸ’§', 'ğŸ’¦', 'ğŸ«§',

    // Flags
    // National flags
    'ğŸ‡¦ğŸ‡«','ğŸ‡¦ğŸ‡±','ğŸ‡©ğŸ‡¿','ğŸ‡¦ğŸ‡©','ğŸ‡¦ğŸ‡´','ğŸ‡¦ğŸ‡¬','ğŸ‡¦ğŸ‡·','ğŸ‡¦ğŸ‡²','ğŸ‡¦ğŸ‡º','ğŸ‡¦ğŸ‡¹','ğŸ‡¦ğŸ‡¿','ğŸ‡§ğŸ‡¸','ğŸ‡§ğŸ‡­','ğŸ‡§ğŸ‡©','ğŸ‡§ğŸ‡§','ğŸ‡§ğŸ‡¾','ğŸ‡§ğŸ‡ª','ğŸ‡§ğŸ‡¿','ğŸ‡§ğŸ‡¯','ğŸ‡§ğŸ‡¹','ğŸ‡§ğŸ‡´','ğŸ‡§ğŸ‡¦','ğŸ‡§ğŸ‡¼','ğŸ‡§ğŸ‡·','ğŸ‡§ğŸ‡³','ğŸ‡§ğŸ‡¬','ğŸ‡§ğŸ‡«','ğŸ‡§ğŸ‡®','ğŸ‡¨ğŸ‡»','ğŸ‡°ğŸ‡­','ğŸ‡¨ğŸ‡²','ğŸ‡¨ğŸ‡¦','ğŸ‡¨ğŸ‡«','ğŸ‡¹ğŸ‡©','ğŸ‡¨ğŸ‡±','ğŸ‡¨ğŸ‡³','ğŸ‡¨ğŸ‡´','ğŸ‡°ğŸ‡²','ğŸ‡¨ğŸ‡¬','ğŸ‡¨ğŸ‡©','ğŸ‡¨ğŸ‡·','ğŸ‡­ğŸ‡·','ğŸ‡¨ğŸ‡º','ğŸ‡¨ğŸ‡¾','ğŸ‡¨ğŸ‡¿','ğŸ‡©ğŸ‡°','ğŸ‡©ğŸ‡¯','ğŸ‡©ğŸ‡²','ğŸ‡©ğŸ‡´','ğŸ‡ªğŸ‡¨','ğŸ‡ªğŸ‡¬','ğŸ‡¸ğŸ‡»','ğŸ‡¬ğŸ‡¶','ğŸ‡ªğŸ‡·','ğŸ‡ªğŸ‡ª','ğŸ‡ªğŸ‡¸','ğŸ‡ªğŸ‡¹','ğŸ‡«ğŸ‡²','ğŸ‡«ğŸ‡®','ğŸ‡«ğŸ‡·','ğŸ‡¬ğŸ‡¦','ğŸ‡¬ğŸ‡²','ğŸ‡¬ğŸ‡ª','ğŸ‡©ğŸ‡ª','ğŸ‡¬ğŸ‡­','ğŸ‡¬ğŸ‡·','ğŸ‡¬ğŸ‡©','ğŸ‡¬ğŸ‡¹','ğŸ‡¬ğŸ‡³','ğŸ‡¬ğŸ‡¼','ğŸ‡¬ğŸ‡¾','ğŸ‡­ğŸ‡¹','ğŸ‡­ğŸ‡³','ğŸ‡­ğŸ‡º','ğŸ‡®ğŸ‡¸','ğŸ‡®ğŸ‡³','ğŸ‡®ğŸ‡©','ğŸ‡®ğŸ‡·','ğŸ‡®ğŸ‡¶','ğŸ‡®ğŸ‡ª','ğŸ‡®ğŸ‡±','ğŸ‡®ğŸ‡¹','ğŸ‡¯ğŸ‡²','ğŸ‡¯ğŸ‡µ','ğŸ‡¯ğŸ‡´','ğŸ‡°ğŸ‡¿','ğŸ‡°ğŸ‡ª','ğŸ‡°ğŸ‡®','ğŸ‡°ğŸ‡µ','ğŸ‡°ğŸ‡·','ğŸ‡½ğŸ‡°','ğŸ‡°ğŸ‡¼','ğŸ‡°ğŸ‡¬','ğŸ‡±ğŸ‡¦','ğŸ‡±ğŸ‡»','ğŸ‡±ğŸ‡§','ğŸ‡±ğŸ‡¸','ğŸ‡±ğŸ‡·','ğŸ‡±ğŸ‡¾','ğŸ‡±ğŸ‡®','ğŸ‡±ğŸ‡¹','ğŸ‡±ğŸ‡º','ğŸ‡²ğŸ‡¬','ğŸ‡²ğŸ‡¼','ğŸ‡²ğŸ‡¾','ğŸ‡²ğŸ‡»','ğŸ‡²ğŸ‡±','ğŸ‡²ğŸ‡¹','ğŸ‡²ğŸ‡­','ğŸ‡²ğŸ‡·','ğŸ‡²ğŸ‡º','ğŸ‡²ğŸ‡½','ğŸ‡²ğŸ‡©','ğŸ‡²ğŸ‡¨','ğŸ‡²ğŸ‡³','ğŸ‡²ğŸ‡ª','ğŸ‡²ğŸ‡¦','ğŸ‡²ğŸ‡¿','ğŸ‡²ğŸ‡²','ğŸ‡³ğŸ‡¦','ğŸ‡³ğŸ‡·','ğŸ‡³ğŸ‡µ','ğŸ‡³ğŸ‡±','ğŸ‡³ğŸ‡¿','ğŸ‡³ğŸ‡®','ğŸ‡³ğŸ‡ª','ğŸ‡³ğŸ‡¬','ğŸ‡³ğŸ‡´','ğŸ‡´ğŸ‡²','ğŸ‡µğŸ‡°','ğŸ‡µğŸ‡¼','ğŸ‡µğŸ‡¸','ğŸ‡µğŸ‡¦','ğŸ‡µğŸ‡¬','ğŸ‡µğŸ‡¾','ğŸ‡µğŸ‡ª','ğŸ‡µğŸ‡­','ğŸ‡µğŸ‡±','ğŸ‡µğŸ‡¹','ğŸ‡¶ğŸ‡¦','ğŸ‡·ğŸ‡´','ğŸ‡·ğŸ‡º','ğŸ‡·ğŸ‡¼','ğŸ‡°ğŸ‡³','ğŸ‡±ğŸ‡¨','ğŸ‡»ğŸ‡¨','ğŸ‡¼ğŸ‡¸','ğŸ‡¸ğŸ‡²','ğŸ‡¸ğŸ‡¹','ğŸ‡¸ğŸ‡¦','ğŸ‡¸ğŸ‡³','ğŸ‡·ğŸ‡¸','ğŸ‡¸ğŸ‡¨','ğŸ‡¸ğŸ‡±','ğŸ‡¸ğŸ‡¬','ğŸ‡¸ğŸ‡°','ğŸ‡¸ğŸ‡®','ğŸ‡¸ğŸ‡§','ğŸ‡¸ğŸ‡´','ğŸ‡¿ğŸ‡¦','ğŸ‡¸ğŸ‡¸','ğŸ‡ªğŸ‡¸','ğŸ‡±ğŸ‡°','ğŸ‡¸ğŸ‡©','ğŸ‡¸ğŸ‡·','ğŸ‡¸ğŸ‡ª','ğŸ‡¨ğŸ‡­','ğŸ‡¸ğŸ‡¾','ğŸ‡¹ğŸ‡¼','ğŸ‡¹ğŸ‡¯','ğŸ‡¹ğŸ‡¿','ğŸ‡¹ğŸ‡­','ğŸ‡¹ğŸ‡±','ğŸ‡¹ğŸ‡¬','ğŸ‡¹ğŸ‡´','ğŸ‡¹ğŸ‡¹','ğŸ‡¹ğŸ‡³','ğŸ‡¹ğŸ‡·','ğŸ‡¹ğŸ‡²','ğŸ‡¹ğŸ‡»','ğŸ‡ºğŸ‡¬','ğŸ‡ºğŸ‡¦','ğŸ‡¦ğŸ‡ª','ğŸ‡¬ğŸ‡§','ğŸ‡ºğŸ‡¸','ğŸ‡ºğŸ‡¾','ğŸ‡ºğŸ‡¿','ğŸ‡»ğŸ‡º','ğŸ‡»ğŸ‡¦','ğŸ‡»ğŸ‡ª','ğŸ‡»ğŸ‡³','ğŸ‡¾ğŸ‡ª','ğŸ‡¿ğŸ‡²','ğŸ‡¿ğŸ‡¼',
    // Popular non-national flags
    'ğŸ³ï¸â€ğŸŒˆ','ğŸ´â€â˜ ï¸','ğŸ³ï¸','ğŸ','ğŸš©','ğŸ´','ğŸ³ï¸â€âš§ï¸','ğŸ³ï¸â€ğŸŒˆ',

  ];

  @override
  void initState() {
    super.initState();
    if (_isEditing) {
      _nameController.text = widget.categoryToEdit!.name;
      _selectedIcon = widget.categoryToEdit!.icon;
      if (!_emojiOptions.contains(_selectedIcon)) {
        _selectedIcon = _emojiOptions.isNotEmpty ? _emojiOptions.first : '';
      }
    } else if (_emojiOptions.isNotEmpty) {
      _selectedIcon = _emojiOptions.first;
    }
  }

  @override
  void dispose() {
    _nameController.dispose();
    super.dispose();
  }

  Future<void> _saveCategory() async {
    if (_formKey.currentState!.validate() && _selectedIcon.isNotEmpty) {
      setState(() {
        _isLoading = true;
      });

      final name = _nameController.text.trim();
      final icon = _selectedIcon;

      try {
        UserCategory resultCategory;
        if (_isEditing) {
          final updatedCategory = widget.categoryToEdit!.copyWith(
            name: name,
            icon: icon,
          );
          await _experienceService.updateUserCategory(updatedCategory);
          resultCategory = updatedCategory;
          print("Category updated: ${resultCategory.name}");
        } else {
          resultCategory = await _experienceService.addUserCategory(name, icon);
          print("Category added: ${resultCategory.name}");
        }

        if (mounted) {
          Navigator.of(context).pop(resultCategory);
        }
      } catch (e) {
        print("Error saving category: $e");
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
                content: Text(
                    'Error ${_isEditing ? "updating" : "adding"} category: ${e.toString()}')),
          );
          setState(() {
            _isLoading = false;
          });
        }
      }
    } else if (_selectedIcon.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please select an icon.')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final bottomPadding = MediaQuery.of(context).viewInsets.bottom;

    return Material(
      color: Colors.white,
      child: Padding(
        padding: EdgeInsets.only(
          left: 16.0,
          right: 16.0,
          top: 20.0,
          bottom: bottomPadding + 20.0,
        ),
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(_isEditing ? 'Edit Category' : 'Create a New Category',
                    style: Theme.of(context).textTheme.titleLarge),
                IconButton(
                  icon: const Icon(Icons.close),
                  onPressed: () => Navigator.of(context).pop(),
                  tooltip: 'Cancel',
                ),
              ],
            ),
            TextFormField(
              controller: _nameController,
              decoration: InputDecoration(
                labelText: _isEditing
                    ? 'Edit category name'
                    : 'Name your new category',
                border: OutlineInputBorder(),
                filled: true,
                fillColor: Colors.white,
              ),
              textCapitalization: TextCapitalization.sentences,
              validator: (value) {
                if (value == null || value.trim().isEmpty) {
                  return 'Please enter a category name';
                }
                return null;
              },
            ),
            const SizedBox(height: 16),
            Text('Select Icon', style: Theme.of(context).textTheme.titleMedium),
            const SizedBox(height: 8),
            SizedBox(
              height: 300,
              child: GridView.builder(
                gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 6,
                  crossAxisSpacing: 8,
                  mainAxisSpacing: 8,
                ),
                itemCount: _emojiOptions.length,
                itemBuilder: (context, index) {
                  final emoji = _emojiOptions[index];
                  final isSelected = emoji == _selectedIcon;
                  return GestureDetector(
                    onTap: () {
                      setState(() {
                        _selectedIcon = emoji;
                      });
                    },
                    child: Container(
                      decoration: BoxDecoration(
                        color: isSelected
                            ? Colors.blue.shade100
                            : Colors.grey.shade200,
                        borderRadius: BorderRadius.circular(8),
                        border: isSelected
                            ? Border.all(color: Colors.blue, width: 2)
                            : null,
                      ),
                      alignment: Alignment.center,
                      child: Text(
                        emoji,
                        style: const TextStyle(fontSize: 24),
                      ),
                    ),
                  );
                },
              ),
            ),
            const SizedBox(height: 20),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                icon: _isLoading
                    ? Container(
                        width: 20,
                        height: 20,
                        padding: const EdgeInsets.all(2.0),
                        child: const CircularProgressIndicator(
                            strokeWidth: 3, color: Colors.white),
                      )
                    : const Icon(Icons.save),
                label: Text(_isLoading
                    ? 'Saving...'
                    : _isEditing
                        ? 'Update Category'
                        : 'Save Category'),
                onPressed: _isLoading ? null : _saveCategory,
                style: ElevatedButton.styleFrom(
                  padding: const EdgeInsets.symmetric(vertical: 12),
                ),
              ),
            ),
          ],
        ),
      ),
    ),
  );
}
}
